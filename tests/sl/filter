method filter(x)
    requires lseg(next, x, null);
    ensures lseg(next, x, null);
{
    prv := null;
    curr := x;
    while (curr != null) 
      invariant ((lseg(next, x,prv) * prv |-> curr || prv == null * x == curr) * lseg(next, curr,null));
    {
      old_curr := curr;
      curr := curr.next;
      if (Random) {
        if (prv != null) {
          prv.next := old_curr.next;
        } else {
          x := old_curr.next;
        }
        free old_curr;
      } else {
        prv := old_curr;
      }
    }
}
